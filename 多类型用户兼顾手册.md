# WebUI 文件监控工具 - 多类型用户兼顾手册

本文档为不同 AI 绘图软件和硬件配置的用户提供详细配置指南，包括文件路径探测、日期文件夹支持和显卡驱动兼容性解决方案。

---

## 📋 目录导航

- [快速开始](#快速开始)
- [主流 AI 绘图软件配置](#主流-ai-绘图软件配置)
- [文件结构对比](#文件结构对比)
- [显卡驱动问题处理](#显卡驱动问题处理)
- [高级配置](#高级配置)
- [常见问题排查](#常见问题排查)

---

## 快速开始

### 1️⃣ 配置文件位置

WebUIMonitor.exe 同级目录中的 `config.json`

### 2️⃣ 基础配置格式

```json
{
  "MonitoringPath": "你的AI绘图输出文件夹路径",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

### 3️⃣ 修改配置步骤

1. 关闭应用程序（可选）
2. 用记事本或任何文本编辑器打开 `config.json`
3. 修改 `MonitoringPath` 为你的实际输出路径
4. 保存文件（UTF-8 编码）
5. 重启应用，新配置立即生效

---

## 主流 AI 绘图软件配置

### 1. Stable Diffusion WebUI（官方/基于 WebUI 的所有派生版本）

#### 📂 文件结构
```
Stable Diffusion WebUI/
├── outputs/
│   ├── txt2img-images/              # txt2img 输出
│   │   ├── 2025-11-21/              # 【日期子文件夹】
│   │   │   ├── 00001-xxx.png
│   │   │   ├── 00002-xxx.png
│   │   │   └── ...
│   │   ├── 2025-11-20/
│   │   └── ...
│   ├── img2img-images/              # img2img 输出
│   │   ├── 2025-11-21/
│   │   └── ...
│   └── txt2img-grids/               # 网格输出
│       ├── 2025-11-21/
│       └── ...
```

#### ✅ 配置示例

**标准安装路径**：
```json
{
  "MonitoringPath": "C:\\stable-diffusion-webui\\outputs\\txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

**自定义安装路径**：
```json
{
  "MonitoringPath": "D:\\AI\\StableDiffusion\\outputs\\txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

**仅监控输出根目录**（如果你希望监控所有类型的输出）：
```json
{
  "MonitoringPath": "C:\\stable-diffusion-webui\\outputs",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

#### 🎯 工作原理
- 应用会自动检测 `MonitoringPath/yyyy-MM-dd` 格式的日期子文件夹
- 每天午夜自动切换到新的日期文件夹
- 如果日期子文件夹不存在，自动回退到配置的基础路径

---

### 2. ComfyUI

#### 📂 文件结构
```
ComfyUI/
├── output/                          # 默认输出目录（无日期子文件夹）
│   ├── 00001-xxx.png
│   ├── 00002-xxx.png
│   └── ...
│
└── 【自定义输出目录】
    ├── output_with_dates/           # 如果用户创建日期子文件夹
    │   ├── 2025-11-21/
    │   ├── 2025-11-20/
    │   └── ...
```

#### ✅ 配置示例

**默认输出目录（无日期子文件夹）**：
```json
{
  "MonitoringPath": "C:\\ComfyUI\\output",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

**自定义输出目录（有日期子文件夹）**：
```json
{
  "MonitoringPath": "D:\\outputs\\comfyui\\output_with_dates",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

#### 🎯 特殊说明
- ⚠️ 默认情况下 ComfyUI 不会自动创建日期子文件夹
- 如果你需要日期子文件夹功能，需要自行创建目录结构或使用 ComfyUI 的自定义节点
- 应用会自动适配两种情况

---

### 3. Invoke AI

#### 📂 文件结构
```
Invoke AI/
├── outputs/
│   ├── images/                      # 生成的图像
│   │   ├── [2025-11-21]/            # 【日期子文件夹】（方括号格式）
│   │   │   ├── image-1.png
│   │   │   └── ...
│   │   ├── [2025-11-20]/
│   │   └── ...
│   └── uploads/                     # 上传的图像
```

#### ✅ 配置示例

```json
{
  "MonitoringPath": "C:\\InvokeAI\\outputs\\images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

#### 🎯 特殊说明
- Invoke AI 使用 `[yyyy-MM-dd]` 格式（带方括号）的日期子文件夹
- 应用内部会自动转换日期格式进行匹配

---

### 4. AUTOMATIC1111 WebUI 的其他分支版本

#### 常见分支
- **中文优化版本**：`sd-webui-cn`
- **轻量版本**：`sd-webui-minimal`
- **模型专用版本**：`novelai-webui`, `chilloutmix-webui` 等

#### ✅ 配置示例

这些分支版本大多兼容原始 AUTOMATIC1111 的文件结构：

```json
{
  "MonitoringPath": "C:\\sd-webui-cn\\outputs\\txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

---

### 5. 其他 UI / 自定义软件

#### 🔍 如何查找输出路径

1. **打开 AI 绘图软件的设置 / 偏好设置**
2. **查找 "Output Path"、"保存位置" 或类似选项**
3. **记下完整的文件夹路径**
4. **使用资源管理器验证路径确实存在**

#### ✅ 通用配置模板

```json
{
  "MonitoringPath": "【你的输出文件夹完整路径】",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

#### 例如：
- **ModelScope Text-to-Image**：`C:\ModelScope\outputs`
- **Midjourney 本地版本**：`C:\Midjourney\generated\images`
- **其他自定义软件**：根据实际配置修改

---

## 文件结构对比

| 软件 | 输出路径 | 日期子文件夹 | 自动切换 | 配置复杂度 |
|------|---------|------------|---------|----------|
| **Stable Diffusion WebUI** | `outputs/txt2img-images` | ✅ 自动 (yyyy-MM-dd) | ✅ 自动 | ⭐ 简单 |
| **ComfyUI** | `output` | ⚠️ 无（需自建或自定义） | ❌ 无 | ⭐⭐ 中等 |
| **Invoke AI** | `outputs/images` | ✅ 自动 ([yyyy-MM-dd]) | ✅ 自动 | ⭐ 简单 |
| **其他 UI** | 不同 | 取决于软件 | 取决于软件 | ⭐⭐⭐ 复杂 |

---

## 显卡驱动问题处理

### ⚠️ N 卡（NVIDIA）问题现象

N 卡用户可能遇到以下情况：

- ❌ 应用启动时卡顿或崩溃
- ❌ GPU 显存数据显示为 0 或异常值
- ❌ 显卡驱动版本过旧或不兼容
- ❌ 开发者电脑的显卡型号与用户显卡型号差异大（难以测试）

#### 原因分析

本应用使用多种方式读取 GPU 显存信息：
1. **PowerShell Performance Counter**（最常用）
2. **DXGI API**（备选）
3. **NVIDIA NVML**（当安装 CUDA 时）

由于不同显卡型号、驱动版本、CUDA 版本的差异，某些方式在某些配置上可能无法正常工作。开发者的测试环境可能与实际用户环境差异较大，导致某些边界情况无法在开发阶段发现。

### 🔧 解决方案

#### 方案 1: 更新显卡驱动（推荐）

**步骤**：
1. 打开 NVIDIA 控制面板
2. 左下角点击 "帮助" → "系统信息"
3. 查看当前驱动版本（应为 550+ 版本，2024年以后）
4. 访问 [NVIDIA 官网驱动下载](https://www.nvidia.com/Download/driverDetails.aspx)
5. 选择你的显卡型号和操作系统，下载最新驱动
6. 安装驱动后重启电脑

**验证**：
- 打开 NVIDIA 控制面板，确认驱动版本已更新
- 重新运行本应用，GPU 数据应正常显示

#### 方案 2: 启用兼容性模式（备选）

如果更新驱动后仍有问题：

1. 右键 `WebUIMonitor.exe`
2. 选择 "属性" → "兼容性" 标签
3. 勾选 "以兼容模式运行此程序"
4. 选择 "Windows 10" 或 "Windows 11"
5. 勾选 "以管理员身份运行此程序"
6. 应用更改，重新启动应用

#### 方案 3: 收集诊断信息

如果更新驱动和兼容性模式都无法解决问题，请运行以下命令收集诊断信息：

```powershell
# 获取显卡信息
Get-WmiObject -Class Win32_VideoController | Select-Object Name, DriverVersion, AdapterRAM | Format-List

# 获取 NVIDIA 显卡详细信息（如已安装 CUDA）
nvidia-smi

# 获取 .NET 运行时版本
dotnet --version
```

### ⚠️ AMD 卡（A 卡）问题现象

AMD GPU 用户可能遇到的问题：

- ❌ GPU 显存数据显示不正确或为 0
- ❌ 应用优先支持 NVIDIA 显卡

#### 解决方案

1. **更新 AMD 显卡驱动**
   - 访问 [AMD 官网驱动下载](https://www.amd.com/en/support)
   - 下载最新的 Radeon 驱动

2. **安装 AMD 工具**
   - 安装 Radeon Pro 驱动套件（包含显存查询工具）
   - 或使用 AMD Radeon Settings

3. **收集诊断信息**
   ```powershell
   # 获取 AMD 显卡信息
   Get-WmiObject -Class Win32_VideoController | Format-List Name, DriverVersion
   ```

### ⚠️ Intel 核显问题现象

使用 Intel 核显的用户可能遇到的问题：

- ⚠️ 显存为共享系统内存（显示数值与独立显卡不同）
- ⚠️ 性能相对较低，不适合大型模型推理

#### 解决方案

1. **更新 Intel 显卡驱动**
   - 访问 [Intel 官网驱动下载](https://www.intel.com/content/www/us/en/download-center/home.html)
   - 搜索你的 CPU 型号，下载最新 iGPU 驱动

2. **预期值调整**
   - Intel 核显的显存数值显示的是共享系统内存
   - 不能与独立显卡的专属显存直接对比

3. **性能建议**
   - 建议用于 CPU 推理或小模型
   - 大型模型建议配置独立显卡

---

## 高级配置

### 路径规范

#### Windows 本地路径
```json
{
  "MonitoringPath": "C:\\stable-diffusion-webui\\outputs\\txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

**注意**：路径中的反斜杠 `\` 需要转义为 `\\`

#### 或使用正斜杠（更简洁）
```json
{
  "MonitoringPath": "C:/stable-diffusion-webui/outputs/txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}
```

#### 网络共享路径
```json
{
  "MonitoringPath": "\\\\192.168.1.100\\shared\\ai-output",
  "AudioPath": "\\\\server\\shared\\sounds\\alarm.wav",
  "AutoDetect": false
}
```

**注意**：网络路径需要 4 个反斜杠 `\\\\` 开头

### 日期文件夹自动检测

应用会按以下优先级查找监控路径：

1. **检查** `配置路径/yyyy-MM-dd` 是否存在
   - 示例：`C:\outputs\txt2img-images\2025-11-21`
2. **如果存在**：监控该日期子文件夹
3. **如果不存在**：监控配置的基础路径
4. **每天午夜自动切换**到新的日期文件夹

#### 支持的日期格式

| 格式 | 示例 | 软件 |
|------|------|------|
| `yyyy-MM-dd` | `2025-11-21` | Stable Diffusion WebUI, ComfyUI |
| `[yyyy-MM-dd]` | `[2025-11-21]` | Invoke AI |

### 日期文件夹自动切换机制

**核心机制**：
- 应用在每次采样时（500ms 间隔）比较当前系统日期与上一次记录的日期
- 日期改变时自动重置文件监控状态，切换到新的日期文件夹
- 即使新日期文件夹还未创建，应用也会自动检测并切换

**工作流程**：
```
启动应用
  ↓
读取 MonitoringPath 配置
  ↓
每 500ms 采样一次
  ↓
  └─→ 获取当前系统日期（yyyy-MM-dd 格式）
      ↓
      └─→ 与上一次记录的日期比较
          ├─ 日期相同 → 继续监控当前路径
          └─ 日期改变 → 重置文件监控状态，尝试切换到新日期文件夹
              ├─ 新日期文件夹存在 → 监控新文件夹
              └─ 新日期文件夹不存在 → 监控基础路径（回退）
```

---

## 常见问题排查

### Q1: 为什么应用找不到输出文件夹？

**A**: 
1. 检查路径是否正确（复制文件夹地址栏里的路径）
2. 确认路径存在（用资源管理器打开验证）
3. 确保路径使用正确的分隔符 `\\` 或 `/`
4. 如果路径包含中文，确保保存文件为 UTF-8 编码
5. 检查是否有读取权限（右键文件夹 → 属性 → 安全）

### Q2: 修改了 config.json 但没有生效？

**A**:
- 需要重启应用程序（新配置在启动时读取）
- 检查 JSON 格式是否正确（可用在线 JSON 验证工具）
- 不可以在应用运行时保存 config.json，建议关闭应用后修改

### Q3: GPU 显存显示为 0 或异常值？

**A**:
1. **对于 N 卡**：更新 NVIDIA 显卡驱动到最新版本（550+）
2. **对于 A 卡**：更新 AMD Radeon 驱动
3. **对于核显**：更新 Intel 核显驱动
4. 确认你的电脑有显卡（不是所有电脑都有独立显卡）
5. 在显卡控制面板检查显卡是否被正确识别
6. 尝试兼容性模式运行应用
7. 以管理员身份运行应用

### Q4: 应用启动时崩溃？

**A**:
1. 确认 .NET 10.0 运行时已安装（或使用自包含版本）
2. 检查 config.json 的 JSON 格式是否正确
3. 确保 MonitoringPath 路径存在且可读
4. 检查音频文件 alarm.wav 是否存在
5. 尝试以管理员身份运行应用
6. 尝试兼容性模式（Windows 10 或 Windows 11）

### Q5: 日期文件夹没有自动切换？

**A**:
1. 确认日期文件夹命名为 `yyyy-MM-dd` 格式（例如 `2025-11-21`）
2. 确认新的日期文件夹在配置路径下存在
3. 重启应用程序
4. 检查系统时间是否正确（时间不同步会导致切换失败）
5. 检查应用日志或窗口标题，查看实际监控的是哪个路径

### Q6: 如何知道应用在监控哪个具体文件夹？

**A**:
- 查看应用窗口标题栏或状态栏（如有显示）
- 用记事本打开 MonitoringPath 目录，观察文件时间戳的变化
- 临时在 config.json 中使用绝对路径，观察文件系统中哪个目录的文件在更新

### Q7: 支持同时监控多个输出文件夹吗？

**A**:
- 当前版本不支持（配置只有一个 MonitoringPath）
- 解决方案：运行多个应用实例，每个实例监控不同的路径
- 或将多个输出文件夹的内容同步到一个主文件夹

### Q8: 警报音量太大/太小？

**A**:
1. 检查 Windows 系统音量设置
2. 检查应用音量（在 Windows 音量混合器中调整）
3. 更换警报音频文件（将 alarm.wav 替换为其他 WAV 文件）

### Q9: 不同用户环境下显卡信息读取不一致？

**A**:

这是 **已知限制**。本应用使用多个显卡信息源，优先级如下：

1. **PowerShell Performance Counter**（大多数情况）
2. **DXGI API**（需要 .NET 调用 Windows API）
3. **NVIDIA NVML**（需要 CUDA 工具包）

由于不同显卡型号、驱动版本、系统配置的差异，某些用户环境可能在某个数据源上失败，导致显卡信息不可用。

**建议**：
- 定期更新显卡驱动
- 如果要使用 NVIDIA CUDA 加速，安装对应的 CUDA 工具包
- 反馈问题时，提供 `nvidia-smi` 或 `Get-WmiObject` 的输出结果

---

## 配置文件验证清单

编辑 `config.json` 后，确保以下检查都通过：

- ✅ JSON 格式有效（无多余逗号、引号配对正确）
- ✅ `MonitoringPath` 路径存在且可读
- ✅ 路径使用正确的分隔符（`\\` 或 `/`）
- ✅ 文件以 UTF-8 编码保存
- ✅ 字符串值用双引号 `""` 括起
- ✅ 布尔值为小写 `true` 或 `false`
- ✅ 应用重启后新配置生效

---

## 快速参考表

### 常见软件的推荐配置

```json
// Stable Diffusion WebUI (标准安装)
{
  "MonitoringPath": "C:\\stable-diffusion-webui\\outputs\\txt2img-images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}

// ComfyUI (标准安装)
{
  "MonitoringPath": "C:\\ComfyUI\\output",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}

// Invoke AI (标准安装)
{
  "MonitoringPath": "C:\\InvokeAI\\outputs\\images",
  "AudioPath": "alarm.wav",
  "AutoDetect": true
}

// 网络路径
{
  "MonitoringPath": "\\\\192.168.1.100\\ai-outputs\\sd-images",
  "AudioPath": "\\\\192.168.1.100\\shared\\alarm.wav",
  "AutoDetect": false
}
```

---

## 需要更多帮助？

1. **第一步**：检查上面的 "[常见问题排查](#常见问题排查)" 部分
2. **第二步**：验证 config.json 的 JSON 格式（使用在线 JSON 验证工具）
3. **第三步**：确认 MonitoringPath 路径确实存在
4. **第四步**：检查文件和文件夹权限
5. **第五步**：尝试管理员身份运行应用
6. **第六步**：更新显卡驱动
7. **第七步**：尝试兼容性模式

---

## 提示与建议

💡 **配置文件热修改**：理论上可以在应用运行时编辑 config.json，下次应用重启时会生效。但为了避免文件锁定问题，建议关闭应用后再修改。

💡 **路径验证**：复制文件夹地址栏中的路径最准确。不要手动输入，容易出错。

💡 **日期文件夹调试**：如果不确定日期文件夹是否存在，直接在 MonitoringPath 后面手动创建一个以 `yyyy-MM-dd` 格式命名的文件夹（例如 `2025-11-21`），观察应用是否能自动检测。

💡 **显卡驱动**：建议定期检查显卡驱动更新。老旧驱动可能导致兼容性问题或显卡信息读取失败。

💡 **多显卡系统**：如果电脑有多个显卡（如集成显卡 + 独立显卡），确保 AI 绘图软件使用的是你预期的显卡。部分应用默认使用集成显卡。

---

## 版本信息

- **应用版本**：v1.0
- **支持 .NET 版本**：.NET 10.0 (Windows Desktop)
- **最后更新**：2025-11-21
- **兼容性**：Windows 10 及以上

---

## 反馈与支持

如遇到配置或兼容性问题，请提供以下信息：

1. **操作系统版本**（Windows 10/11）
2. **显卡型号**（N 卡/A 卡/Intel 核显）
3. **显卡驱动版本**
4. **AI 绘图软件及版本**
5. **config.json 的配置内容**（隐藏敏感路径）
6. **错误信息或异常现象**的详细描述

这将帮助开发者快速定位问题并提供解决方案。

---

**祝你使用愉快！** 🎨✨
